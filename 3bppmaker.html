<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG Palette Reducer with Pyodide</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        #drop-zone { border: 2px dashed #666; padding: 20px; margin: 20px auto; width: 80%; cursor: pointer; }
        #file-input { display: none; }
        button { margin-top: 10px; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>PNG Palette Reducer (3bpp) with Pyodide</h1>
    <div id="drop-zone">Drop PNG files here or click to upload</div>
    <input type="file" id="file-input" multiple accept="image/png">
    <button id="process-button" disabled>Process & Download</button>

    <!-- Load Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script>
        const dropZone = document.getElementById("drop-zone");
        const fileInput = document.getElementById("file-input");
        const processButton = document.getElementById("process-button");
        let files = [];

        dropZone.addEventListener("click", () => fileInput.click());
        dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "blue"; });
        dropZone.addEventListener("dragleave", () => dropZone.style.borderColor = "#666");
        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.style.borderColor = "#666";
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener("change", () => handleFiles(fileInput.files));

        function handleFiles(selectedFiles) {
            files = Array.from(selectedFiles);
            processButton.disabled = files.length === 0;
        }

        async function initializePyodide() {
            console.log("Loading Pyodide...");
            const pyodide = await loadPyodide();
            await pyodide.loadPackage("pillow");
            console.log("Pyodide and Pillow are ready!");
            return pyodide;
        }

        processButton.addEventListener("click", async () => {
            const pyodide = await initializePyodide();

            for (const file of files) {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = async () => {
                    const arrayBuffer = reader.result;
                    const uint8Array = new Uint8Array(arrayBuffer);

                    try {
                        // Write the file to Pyodide's virtual file system
                        pyodide.FS.writeFile(file.name, uint8Array);

                        // Debug: Verify the file exists
                        const fileExists = pyodide.FS.analyzePath(file.name).exists;
                        console.log("File exists in Pyodide FS:", fileExists);

                        // Run Python code to process the image
                        const result = await pyodide.runPythonAsync(`
                            from PIL import Image
                            import io

                            try:
                                # Debug: Verify the file can be opened
                                print("Opening image file: ${file.name}")
                                image = Image.open("${file.name}")
                                print("Image format:", image.format)
                                print("Image mode:", image.mode)
                                print("Image size:", image.size)

                                # Convert to 8-color indexed PNG
                                image = image.convert("P", palette=Image.ADAPTIVE, colors=8)
                                print("Image converted to 8-color palette")

                                # Save the processed image to a bytes buffer
                                output_buffer = io.BytesIO()
                                image.save(output_buffer, format="PNG")
                                output_buffer.seek(0)

                                # Debug: Verify the buffer contains data
                                print("Output buffer size:", output_buffer.getbuffer().nbytes)

                                # Return the processed image as bytes
                                output_buffer.getvalue()
                            except Exception as e:
                                print("Error in Python code:", str(e))
                                raise e
                        `);

                        // Debug: Verify the result is a valid Uint8Array
                        console.log("Result from Python:", result);

                        if (result && result.length > 0) {
                            // Convert the result to a Blob and download
                            const blob = new Blob([result], { type: "image/png" });
                            const link = document.createElement("a");
                            link.download = file.name;
                            link.href = URL.createObjectURL(blob);
                            link.click();
                        } else {
                            console.error("No image data returned from Python.");
                        }
                    } catch (error) {
                        console.error("Error processing image:", error);
                    }
                };
            }
        });
    </script>
</body>
</html>